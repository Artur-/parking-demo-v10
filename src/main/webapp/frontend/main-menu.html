<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/vaadin-tabs/src/vaadin-tabs.html">
<link rel="import" href="bower_components/vaadin-tabs/src/vaadin-tab.html">
<link rel="import" href="bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="online-detector.html">

<dom-module id="main-menu">
    <template>
        <style>
        </style>
        <online-detector id="detector"></online-detector>
        <vaadin-tabs  id="menu">
            <a on-click="maybeNavigate" router-link href="">
                <vaadin-tab selected="[[_equals(route, '')]]">
                    <iron-icon icon="vaadin:ticket"></iron-icon>Ticket</vaadin-tab>
            </a>
            <a on-click="maybeNavigate" router-link href="map">
                <vaadin-tab selected="[[_equals(route, 'map')]]">
                    <iron-icon icon="vaadin:map-marker"></iron-icon>24h Map</vaadin-tab>
            </a>
            <a on-click="maybeNavigate" router-link href="shifts">
                <vaadin-tab selected="[[_equals(route, 'shifts')]]">
                    <iron-icon icon="vaadin:table"></iron-icon>Shifts</vaadin-tab>
            </a>
            <a on-click="maybeNavigate" router-link href="stats">
                <vaadin-tab selected="[[_equals(route, 'stats')]]">
                    <iron-icon icon="vaadin:chart"></iron-icon>Stats</vaadin-tab>
            </a>
        </vaadin-tabs>
    </template>
    <script>
        class MainMenu extends Polymer.Element {
            static get is() {
                return 'main-menu';
            }
            static get properties() {
                return {
                    route: {
                        type: String
                    }
                }
            }
            connectedCallback() {
                super.connectedCallback();
                this.updateRoute();
                this.hackPushState();
                if (!this.$.detector.appOnline) {
                    this.navigateOffline(window.location.href);
                }
            }
            _equals(route, viewName) {
                return route == viewName;
            }
            maybeNavigate(e) {
                if (!this.$.detector.appOnline) {
                    e.stopPropagation();
                    e.preventDefault();
                    this.navigateOffline(e.currentTarget.href);
                }
            }
            navigateOffline(targetHref) {
                const targetView = targetHref.replace(document.baseURI,"");
                if (targetView == "map")
                    return;
                this.dispatchEvent(new CustomEvent('navigate', {detail: {view: targetView}}));
            }
            updateRoute() {
                var p = window.location.pathname;
                if (p.indexOf("/") == 0) {
                    p = p.substring(1);
                }
                this.route = p;
            }
            hackPushState() {
                // No browser gives navigation eventgs
                // Flow does not give navigation events
                // Rely on pushState being used for navigation

                var self = this;
                var pushState = history.pushState;
                window.history.pushState = function (state) {
                    pushState.apply(window.history, arguments);
                    self.updateRoute();
                };

            }
        }
        customElements.define(MainMenu.is, MainMenu);
    </script>
</dom-module>